#!/bin/bash
#
# Script de creation d'un nouveau client sur un serveur OpenVPN
# http://blog.nicolargo.com/2010/10/installation-dun-serveur-openvpn-sous-debianubuntu.html
#
# Authors:
# - Nicolargo (aka Nicolas Hennion)
# - Franï¿½ois ANTON (add choice for certificate password)
# - Kimpe Andy (add conpatibility for windows vista and windows 7)
#
# GPLv3
#
# Syntaxe: # sudo ./ovcreateclient.sh <nomduclient>
#
VERSION="0.5"
remote=$(cat remote)

maison=clientconf/$1
orig=$maison/$1.conf
origtcp=$maison/$1-tcp.conf

echo -e "---------------------------------"
echo -e "openvpn auto createclient v $VERSION"
echo -e "---------------------------------"
LANGUAGE=fr.sh
source openvpnlang/$LANGUAGE

# Test parametre
if [ $# -ne 1 ]; then
  echo -e "$mustclient # sudo $0 <$nameclient>" 1>&2
  exit 1
fi

cd easy-rsa

echo -e "$createclient $1"
echo -e $certif1
echo -e "1) $certif2"
echo -e "2) $certif3"
read key

case $key in
	1)
		echo -e "$createclient2 $1"
		source vars
		./build-key $1
		;;

	2)
		echo "$createclient3 $1"
		source vars
		./build-key-pass $1
		;;

	*)
		echo -e $error
		echo -e $stop
		exit 0
		;;
esac

sudo mkdir $maison
sudo cp keys/ca.crt keys/ta.key keys/$1.crt keys/$1.key $maison
cd $maison

cp template.conf $orig
sed -i "s/PROTO/udp/g"
sed -i "s/REMOTE/$remote/g"
sed -i "s/PORT/1194/g"
sed -i "s/CERT/$1.crt/g"
sed -i "s/KEY/$1.key/g"

cp template.conf $origtcp
sed -i "s/PROTO/tcp-client/g"
sed -i "s/REMOTE/$remote/g"
sed -i "s/PORT/11194/g"
sed -i "s/CERT/$1.crt/g"
sed -i "s/KEY/$1.key/g"

sudo zip $1.zip *.*

echo -e "$createclient $1 $finish"
echo "$maison/$1.zip" 
echo "---"
